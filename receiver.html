<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<!--
  receiver.html v8 â€” Chromecast Custom Receiver (WebRTC Video Track)

  Architecture:
    Phone â†’ WebRTC PeerConnection (video track / RTP) â†’ This receiver
    pc.ontrack â†’ video.srcObject = stream   â† NO MSE, NO SourceBuffer!

  Signaling:
    WEBRTC_OFFER  (phoneâ†’receiver) â†’ SDP offer
    WEBRTC_ANSWER (receiverâ†’phone) â†’ SDP answer
    WEBRTC_ICE    (bidirectional)   â†’ ICE candidates
    SHOW_WELCOME  (phoneâ†’receiver) â†’ welcome image URL (field: imageUrl)
    STOP_STREAM   (phoneâ†’receiver) â†’ tear down
    SET_SOUND     (phoneâ†’receiver) â†’ mute/unmute
-->
<script src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
<style>
html, body {
    margin: 0; padding: 0;
    width: 100%; height: 100%;
    background: #000; overflow: hidden;
}
video {
    width: 100%; height: 100%;
    object-fit: contain;
    background: #000;
}
#welcome-img {
    display: none;
    position: fixed; top: 0; left: 0;
    width: 100%; height: 100%;
    object-fit: contain;
    background: #000;
    z-index: 5;
}
#status {
    position: fixed; top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    color: #fff; font: 24px -apple-system, sans-serif;
    text-align: center;
    display: none;
    z-index: 10;
}
</style>
</head>
<body>
<img id="welcome-img" />
<video id="video" autoplay playsinline muted></video>
<div id="status"></div>

<script>
'use strict';

// â”€â”€ Constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var NS    = 'urn:x-cast:com.screenmirror.stream';
var ctx   = cast.framework.CastReceiverContext.getInstance();
var video = document.getElementById('video');
var welc  = document.getElementById('welcome-img');
var stat  = document.getElementById('status');

var RTC = window.RTCPeerConnection || window.webkitRTCPeerConnection;

var pc        = null;
var startTime = 0;
var diagTimer = null;
var senderID  = null;

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function log(m) { console.log('[RECV] ' + m); }

function showStatus(text) {
    stat.textContent = text;
    stat.style.display = text ? 'block' : 'none';
}

/** Send a message back to the phone via Cast namespace. */
function send(obj) {
    if (!senderID) return;
    try {
        ctx.sendCustomMessage(NS, senderID, JSON.stringify(obj));
    } catch (e) {
        log('sendCustomMessage error: ' + e);
    }
}

/** Send a diagnostic/status message visible in phone logs as ðŸ“º RECEIVER: */
function diag(text) {
    log(text);
    send({ type: 'STATUS', msg: text });
}

// â”€â”€ Cast Message Handler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ctx.addCustomMessageListener(NS, function(event) {
    // Always track the sender so we can respond
    if (event.senderId) senderID = event.senderId;

    var msg;
    try {
        msg = typeof event.data === 'string'
            ? JSON.parse(event.data) : event.data;
    } catch (e) {
        log('Bad JSON: ' + e);
        return;
    }

    var type = msg.type || '';

    switch (type) {
        case 'WEBRTC_OFFER':
            handleOffer(msg.sdp, msg.soundEnabled);
            break;

        case 'WEBRTC_ICE':
            handleIce(msg);
            break;

        case 'STOP_STREAM':
            stopStream();
            diag('STOP_STREAM');
            break;

        case 'SHOW_WELCOME':
            showWelcome(msg);
            break;

        case 'SET_SOUND':
            video.muted = !msg.enabled;
            diag('Sound ' + (msg.enabled ? 'ON' : 'OFF'));
            break;

        default:
            log('Unknown message type: ' + type);
            break;
    }
});

// â”€â”€ WebRTC Offer â†’ Answer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleOffer(sdp, soundEnabled) {
    diag('WEBRTC_OFFER received');

    // Check WebRTC support
    if (!RTC) {
        diag('WebRTC NOT supported on this device');
        send({ type: 'WEBRTC_UNSUPPORTED' });
        showStatus('WebRTC not supported');
        return;
    }

    if (!sdp) {
        diag('WEBRTC_OFFER: empty SDP');
        return;
    }

    try {
        // Tear down previous session
        stopStream();

        startTime = Date.now();
        welc.style.display = 'none';
        showStatus('Connectingâ€¦');

        // Apply sound setting from offer
        if (soundEnabled !== undefined) {
            video.muted = !soundEnabled;
        }

        diag('Starting WebRTC peer connection');

        // Create PeerConnection
        pc = new RTC({
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        });

        // â”€â”€ Track arrives â†’ play on <video> â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        pc.ontrack = function(ev) {
            diag('Track: ' + ev.track.kind);

            if (ev.streams && ev.streams[0]) {
                video.srcObject = ev.streams[0];
            } else {
                var ms = new MediaStream();
                ms.addTrack(ev.track);
                video.srcObject = ms;
            }

            video.play().then(function() {
                diag('PLAYING');
                showStatus('');
            }).catch(function(e) {
                log('play() error: ' + e);
                video.muted = true;
                video.play().catch(function() {});
                showStatus('');
            });
        };

        // â”€â”€ ICE candidates â†’ send to phone â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        pc.onicecandidate = function(ev) {
            if (ev.candidate) {
                send({
                    type: 'WEBRTC_ICE',
                    sdpMid: ev.candidate.sdpMid,
                    sdpMLineIndex: ev.candidate.sdpMLineIndex,
                    candidate: ev.candidate.candidate
                });
            }
        };

        // â”€â”€ ICE state tracking â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        pc.oniceconnectionstatechange = function() {
            var st = pc ? pc.iceConnectionState : 'null';
            diag('ICE state: ' + st);
            if (st === 'connected' || st === 'completed') {
                showStatus('');
                startDiagTimer();
            } else if (st === 'failed') {
                showStatus('Connection failed');
            } else if (st === 'disconnected') {
                showStatus('Reconnectingâ€¦');
            }
        };

        // â”€â”€ Apply offer â†’ create answer â†’ send back â”€â”€â”€â”€â”€
        var desc = new (window.RTCSessionDescription || Object)({
            type: 'offer', sdp: sdp
        });

        pc.setRemoteDescription(desc)
        .then(function() {
            log('Remote description set');
            return pc.createAnswer();
        })
        .then(function(answer) {
            log('Answer created');
            return pc.setLocalDescription(answer);
        })
        .then(function() {
            diag('WebRTC answer ready, sending to phone');
            send({
                type: 'WEBRTC_ANSWER',
                sdp: pc.localDescription.sdp
            });
        })
        .catch(function(err) {
            diag('SDP error: ' + err);
            showStatus('Negotiation error');
        });

    } catch (e) {
        diag('handleOffer exception: ' + e);
        showStatus('WebRTC error');
    }
}

// â”€â”€ Remote ICE Candidate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleIce(msg) {
    if (!pc) return;
    try {
        var cand = new (window.RTCIceCandidate || Object)({
            sdpMid: msg.sdpMid,
            sdpMLineIndex: msg.sdpMLineIndex,
            candidate: msg.candidate
        });
        pc.addIceCandidate(cand).catch(function(e) {
            log('addIceCandidate error: ' + e);
        });
    } catch (e) {
        log('handleIce exception: ' + e);
    }
}

// â”€â”€ Stop / Cleanup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function stopStream() {
    if (diagTimer) { clearInterval(diagTimer); diagTimer = null; }
    if (pc) {
        try { pc.close(); } catch (e) {}
        pc = null;
    }
    video.srcObject = null;
    showStatus('');
}

// â”€â”€ Welcome Image â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showWelcome(msg) {
    // GoogleCastService sends field "imageUrl" (camelCase)
    var url = msg.imageUrl || msg.imageURL || '';
    if (url) {
        welc.src = url;
        welc.onload = function() {
            welc.style.display = 'block';
            diag('SHOW_WELCOME: ' + url);
        };
        welc.onerror = function() {
            welc.style.display = 'none';
            diag('SHOW_WELCOME image load error: ' + url);
        };
    } else {
        diag('SHOW_WELCOME: no imageUrl');
    }
    video.srcObject = null;
    showStatus('');
}

// â”€â”€ Diagnostics Timer (WebRTC Stats) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startDiagTimer() {
    if (diagTimer) clearInterval(diagTimer);

    diagTimer = setInterval(function() {
        if (!pc) return;
        var elapsed = ((Date.now() - startTime) / 1000).toFixed(1);

        pc.getStats().then(function(stats) {
            var dec = 0, drop = 0, bytes = 0, jitter = 0;
            var rtt = 0, width = 0, height = 0, fps = 0;
            var codec = '';

            stats.forEach(function(r) {
                if (r.type === 'inbound-rtp' && r.kind === 'video') {
                    dec   = r.framesDecoded  || 0;
                    drop  = r.framesDropped  || 0;
                    bytes = r.bytesReceived  || 0;
                    jitter = r.jitter        || 0;
                    fps   = r.framesPerSecond || 0;
                    if (r.frameWidth)  width  = r.frameWidth;
                    if (r.frameHeight) height = r.frameHeight;
                }
                if (r.type === 'candidate-pair' && r.state === 'succeeded') {
                    rtt = r.currentRoundTripTime || 0;
                }
                if (r.type === 'codec' && r.mimeType) {
                    codec = r.mimeType;
                }
            });

            var d = 't=' + elapsed + 's' +
                ' ice=' + pc.iceConnectionState +
                ' dec=' + dec +
                ' drop=' + drop +
                ' fps=' + fps +
                ' ' + width + 'x' + height +
                ' jitter=' + (jitter * 1000).toFixed(1) + 'ms' +
                ' rtt=' + (rtt * 1000).toFixed(0) + 'ms' +
                ' bytes=' + bytes +
                (codec ? ' codec=' + codec : '');

            send({ type: 'DIAG', data: d });
        }).catch(function(e) {
            log('getStats error: ' + e);
        });
    }, 5000);
}

// â”€â”€ Start Cast Receiver â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ctx.start();
log('Receiver v8 ready (WebRTC Video Track)');
</script>
</body>
</html>
